<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D 本地模型查看器 (修正版)</title>
    <style>
        /* CSS样式部分保持不变 */
        html, body {
            height: 100%; margin: 0; padding: 0; background: #fff; color: #222;
            font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden;
        }
        #live2d-container {
            position: fixed; right: 0px; bottom: 0px; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
        }
        #live2d-canvas {
            display: block; width: 100%; height: 100%; background: transparent;
            cursor: grab; pointer-events: auto;
        }
        #live2d-canvas:active { cursor: grabbing; }
        #chat-container { pointer-events: auto; position: fixed; left: 20px; bottom: 20px; width: 340px;
            height: 300px; background: #f7f8fa; opacity: 0.7; border-radius: 12px; padding: 16px;
            box-sizing: border-box; z-index: 20; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex; flex-direction: column; }
        #chat-content-wrapper { flex-grow: 1; padding-left: 8px; overflow-y: auto; opacity: 0.7; }
        #sidebar {
            /*background: #f7f8fa;*/
            /*opacity: 0.7;*/
            border-radius: 12px;
            box-sizing: border-box;
            box-shadow: None;

            background: transparent;
            position: fixed;
            left: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 20;
            min-width: 150px;
            transition: width 0.3s ease, min-width 0.3s ease, height 0.3s ease, padding 0.3s ease, opacity 0.3s;
        }
        .side-btn { padding: 10px 20px; border-radius: 8px; border: none; background: #333;
            color: #fff; font-size: 1rem; cursor: pointer; margin-bottom: 4px;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s; }
        .side-btn:active {
            background: #555;
        }

        .side-btn:disabled {
            background: #e0e0e0;
            color: #888;
            cursor: not-allowed;
            border: 1px solid #ccc;
            opacity: 0.7;
        }

        .side-btn:hover:not(:disabled) {
            background: #4f8cff;
            color: #fff;
        }
        #status {
            /*margin-top: 5px;*/
            color: #4f8cff;
            background: transparent;
            font-size: 0.95rem;
            max-width: 150px;
            word-break: break-all;
        }
        #model-list-container { display: none; flex-direction: column; gap: 8px; margin-top: 10px; width: 130px;}
        .model-select-btn { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc;
            background: #fff; cursor: pointer; text-align: left; }
        .model-select-btn:hover { background: #e8f0fe; border-color: #4f8cff; }
        .save-btn { padding: 10px 20px; border-radius: 8px; border: none; background: #4f8cff;
            color: #fff; font-size: 1rem; cursor: pointer; margin-bottom: 4px;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s; }
        .save-btn:hover { background: #2662c8; }
        .save-btn:disabled { background: #b0c4de; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="sidebar">
    <button id="fullscreenBtn" class="side-btn">🖥️ 全屏</button>
    <button id="exitFullscreenBtn" class="side-btn" style="display:none;">❌ 退出全屏</button>
    <button id="changeModelBtn" class="side-btn">🔄️ 更换模型</button>
    <div id="model-list-container"></div>
    <button id="savePreferencesBtn" class="save-btn" disabled>💾 保存设置</button>
    <button id="micButton" class="side-btn" disabled>🎤 开始聊天</button>
    <button id="muteButton" class="side-btn" disabled>⏸️ 休息一下</button>
    <div id="status">正在从服务器获取模型列表...</div>
    <!-- <button id="screenButton" class="side-btn" disabled>🖥️ 屏幕共享</button>
    <button id="stopButton" class="side-btn" disabled>🛑 暂停共享</button> -->
    <!-- <button id="resetSessionButton" class="side-btn" disabled>👋 请她离开</button> -->
</div>
<div id="chat-container">
    <div id="chat-content-wrapper"><p style="color: #888">对话历史界面<br><br>...现在是一片空白...</p></div>
</div>
<div id="live2d-container"><canvas id="live2d-canvas"></canvas></div>

<script src="/static/libs/live2dcubismcore.min.js"></script>  <!-- Cubism 4核心库（支持Cubism 3/4模型） -->
<script src="/static/libs/live2d.min.js"></script>  <!-- Cubism 2.1核心库（支持旧模型） -->
<script src="/static/libs/pixi.min.js"></script>  <!-- PixiJS v7 CDN -->
<script src="/static/libs/index.min.js"></script>  <!-- pixi-live2d-display v0.5.0-ls-6（RaSan147 fork，支持v7） -->
<script src="/static/live2d.js"></script>  <!-- 使用重构后的 Live2D 管理器 -->

<script>
    // 注入后端传来的 lanlan_name 变量
    const lanlanName = "{{ lanlan_name | default('') }}";
    
    (async function () {
        const statusDiv = document.getElementById('status');
        let currentModelInfo = null;

        // 初始化 Live2D 管理器
        await window.live2dManager.initPIXI('live2d-canvas', 'live2d-container');

        // 设置模型加载回调
        window.live2dManager.onModelLoaded = (model, modelPath) => {
            console.log('模型加载完成:', modelPath);
            if (currentModelInfo) {
                statusDiv.innerText = `加载成功: ${currentModelInfo.name}。您可以拖拽和滚轮缩放模型。`;
            }
            document.getElementById('savePreferencesBtn').disabled = false;
        };

        // 设置状态更新回调
        window.live2dManager.onStatusUpdate = (message) => {
            statusDiv.innerText = message;
        };

        async function setupModelList() {
            try {
                const response = await fetch('/api/models');
                if (!response.ok) throw new Error('网络响应错误');
                const modelsFromServer = await response.json();
                const modelListContainer = document.getElementById('model-list-container');
                modelListContainer.innerHTML = '';
                
                if (modelsFromServer.length > 0) {
                    modelsFromServer.forEach(modelInfo => {
                        const btn = document.createElement('button');
                        btn.innerText = modelInfo.name;
                        btn.className = 'model-select-btn';
                        btn.onclick = async () => { 
                            const preferences = await window.live2dManager.loadUserPreferences();
                            // 查找该模型的历史偏好
                            const modelPreferences = preferences.find(pref => pref && pref.model_path === modelInfo.path);
                            await loadModel(modelInfo, modelPreferences || null); 
                            // 将该模型设为首选
                            try {
                                await fetch('/api/preferences/set-preferred', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ model_path: modelInfo.path })
                                });
                            } catch (error) {
                                console.warn('设置首选模型失败:', error);
                            }
                            modelListContainer.style.display = 'none'; 
                            document.getElementById('changeModelBtn').innerText = '🔄️ 更换模型'; 
                        };
                        modelListContainer.appendChild(btn);
                    });
                    
                    // 加载用户偏好
                    const preferences = await window.live2dManager.loadUserPreferences();
                    console.log('加载的用户偏好:', preferences);
                    let modelToLoad = modelsFromServer[0]; // 默认加载第一个模型
                    let modelPreferences = null;
                    
                    // 如果有保存的偏好，尝试找到对应的模型
                    if (preferences.length > 0 && preferences[0] && preferences[0].model_path) {
                        const savedModel = modelsFromServer.find(model => model.path === preferences[0].model_path);
                        console.log('查找保存的模型:', preferences[0].model_path, '找到:', savedModel);
                        if (savedModel) {
                            modelToLoad = savedModel;
                            modelPreferences = preferences[0];
                            statusDiv.innerText = `发现 ${modelsFromServer.length} 个模型，正在加载首选模型: ${savedModel.name}`;
                        } else {
                            statusDiv.innerText = `发现 ${modelsFromServer.length} 个模型，首选模型不可用，加载默认模型。`;
                        }
                    } else {
                        statusDiv.innerText = `发现 ${modelsFromServer.length} 个模型，请点击按钮选择。`;
                    }
                    
                    // 加载模型并应用偏好设置
                    await loadModel(modelToLoad, modelPreferences);
                } else {
                    statusDiv.innerText = '服务器的 "static" 文件夹下未发现任何模型。';
                }
            } catch (error) { 
                console.error("获取模型列表失败:", error); 
                statusDiv.innerText = '获取模型列表失败，请检查后端服务是否正常运行。'; 
            }
        }

        async function loadModel(modelInfo, preferences = {}) {
            if (!modelInfo || !modelInfo.path) { 
                statusDiv.innerText = "错误：模型路径无效。"; 
                return; 
            }
            
            currentModelInfo = modelInfo;
            statusDiv.innerText = `正在加载模型: ${modelInfo.name}...`;
            
            try {
                // 使用 Live2D 管理器加载模型
                await window.live2dManager.loadModel(modelInfo.path, {
                    preferences: preferences,
                    dragEnabled: true,
                    wheelEnabled: true,
                    loadEmotionMapping: true
                });

                // 设置窗口大小变化监听
                window.addEventListener('resize', () => {
                    const model = window.live2dManager.getCurrentModel();
                    if (model && preferences && preferences.position) {
                        model.x = preferences.position.x;
                        model.y = preferences.position.y;
                    } else if (model) {
                        model.x = window.live2dManager.getPIXIApp().renderer.width;
                        model.y = window.live2dManager.getPIXIApp().renderer.height;
                    }
                });

                statusDiv.innerText = `加载成功: ${modelInfo.name}。您可以拖拽和滚轮缩放模型。`;
                document.getElementById('savePreferencesBtn').disabled = false;
            } catch (error) { 
                console.error("加载模型失败:", error); 
                statusDiv.innerText = `加载模型 "${modelInfo.name}" 失败。请检查路径或F12查看控制台错误。`; 
            }
        }

        // 保存用户偏好
        async function saveUserPreferences() {
            const currentModel = window.live2dManager.getCurrentModel();
            if (!currentModel || !currentModelInfo) {
                statusDiv.innerText = "没有可保存的设置";
                return;
            }
            
            try {
                const success = await window.live2dManager.saveUserPreferences(
                    currentModelInfo.path,
                    { x: currentModel.x, y: currentModel.y },
                    { x: currentModel.scale.x, y: currentModel.scale.y }
                );
                
                if (success) {
                    statusDiv.innerText = "设置已保存！";
                    setTimeout(() => {
                        if (currentModelInfo) {
                            statusDiv.innerText = `当前模型: ${currentModelInfo.name}`;
                        }
                    }, 2000);
                } else {
                    statusDiv.innerText = "保存失败";
                }
            } catch (error) {
                console.error("保存偏好失败:", error);
                statusDiv.innerText = "保存失败，请检查网络连接";
            }
            
            // 保存 live2d 字段到后端
            if (lanlanName && currentModelInfo && currentModelInfo.name) {
                try {
                    const resp = await fetch(`/api/characters/catgirl/l2d/${lanlanName}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ live2d: currentModelInfo.name })
                    });
                    const result = await resp.json();
                    if (!result.success) {
                        statusDiv.innerText += `\n后端保存live2d失败: ${result.error}`;
                    }
                } catch (e) {
                    statusDiv.innerText += '\n后端保存live2d失败，请检查网络';
                }
            }
        }

        document.getElementById('changeModelBtn').addEventListener('click', () => {
            const modelListContainer = document.getElementById('model-list-container');
            const isVisible = modelListContainer.style.display === 'flex';
            if (isVisible) {
                modelListContainer.style.display = 'none';
                document.getElementById('changeModelBtn').innerText = '🔄️ 更换模型';
            } else {
                modelListContainer.style.display = 'flex';
                document.getElementById('changeModelBtn').innerText = '🔼 收起列表';
                statusDiv.innerText = "自动检索Live2D模型...\n请将模型文件置于\n/static文件夹内。";
            }
        });

        // 保存偏好按钮事件监听器
        document.getElementById('savePreferencesBtn').addEventListener('click', saveUserPreferences);
        
        setupModelList();

    })();

    // 全屏/退出全屏按钮逻辑
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');
    fullscreenBtn.onclick = function() {
        if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
        } else if (document.documentElement.webkitRequestFullscreen) {
            document.documentElement.webkitRequestFullscreen();
        } else if (document.documentElement.mozRequestFullScreen) {
            document.documentElement.mozRequestFullScreen();
        } else if (document.documentElement.msRequestFullscreen) {
            document.documentElement.msRequestFullscreen();
        }
    };
    exitFullscreenBtn.onclick = function() {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    };
    // 监听全屏状态变化，切换按钮显示
    function updateFullscreenButtons() {
        const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
        fullscreenBtn.style.display = isFullscreen ? 'none' : '';
        exitFullscreenBtn.style.display = isFullscreen ? '' : 'none';
    }
    document.addEventListener('fullscreenchange', updateFullscreenButtons);
    document.addEventListener('webkitfullscreenchange', updateFullscreenButtons);
    document.addEventListener('mozfullscreenchange', updateFullscreenButtons);
    document.addEventListener('MSFullscreenChange', updateFullscreenButtons);
    // 初始化按钮状态
    updateFullscreenButtons();
</script>

</body>
</html>